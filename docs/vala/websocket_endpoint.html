<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Endpoint Architecture</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        h1 {
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            margin-top: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        pre {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 10px;
            overflow: auto;
        }
        code {
            font-family: Consolas, monospace;
            background-color: #f8f8f8;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .highlight {
            background-color: #ffffcc;
            padding: 2px;
        }
        .note {
            background-color: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 10px;
            margin: 15px 0;
        }
        .warning {
            background-color: #fff8e8;
            border-left: 4px solid #f39c12;
            padding: 10px;
            margin: 15px 0;
        }
        .code-flow {
            display: flex;
            flex-direction: column;
        }
        .code-step {
            margin: 10px 0;
            padding: 10px;
            background-color: #f5f5f5;
            border-left: 3px solid #3498db;
        }
        .diagram {
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">

        <nav>
            <a href="./vala_project.html">Back</a>
        </nav>
    
        <h1>WebSocket Endpoint Architecture</h1>

        <p>This documentation was generate by Claude Code using the single promt documented <a href="./websocket_endpoint_prompt.html">here</a>.</p>

        
        <div class="note">
            This document provides a detailed explanation of the <code>main()</code> function in the <code>websocket_endpoint.vala</code> file, 
            highlighting the initialization sequence and architecture of a multithreaded application that manages multiple asynchronous 
            communication channels including WebSocket connections and local CLI input.
        </div>

        <h2>Main Function Overview</h2>
        <p>
            The <code>main()</code> function serves as the entry point for the application and orchestrates the initialization of various 
            services and components. It follows a specific sequence to ensure all systems are properly initialized before the main event loop begins.
        </p>

        <pre>
int main(string[] args) {
#if INCLUDE_C_BRIDGE_CODE
    stdout.printf("Starting WebSocket server from Vala...\n");
    U7Bridge.init();
    U7ThreadSubscriber.test();
    U7WebSocketManager.test();

    AppDelegate *appDel = new AppDelegate();
    
    if (appDel != null) 
        stdout.printf("AppDelegate\n");

    var input_monitor = new U7KeyboardInputMonitor("U7KeyboardInputMonitor");
    input_monitor.start();
    stdout.printf("include_c_bridge_code=true\n");

    U7ThreadLoop.startMainEventLoop();

#else
    stdout.printf("include_c_bridge_code=false\n");
#endif

    return 0;
}</pre>

        <h2>Service Initialization Sequence</h2>
        <div class="code-flow">
            <div class="code-step">
                <h3>1. U7Bridge Initialization</h3>
                <p>
                    <code>U7Bridge.init()</code> initializes all application-specific support classes and bridge code to the C world. 
                    This is not a service in the sense of a WebSocket service, but rather a foundation layer that initializes all the 
                    code specific to the application that is not tied to the foundation classes shared with the C code that is not 
                    autogenerated by valac.
                </p>
                <p>
                    The bridge acts as an interface layer between Vala's object-oriented code and any C libraries or systems that 
                    the application needs to interact with. It ensures proper communication between different programming paradigms.
                </p>
            </div>

            <div class="code-step">
                <h3>2. Thread Subscriber Initialization</h3>
                <p>
                    <code>U7ThreadSubscriber.test()</code> initializes a dedicated thread that subscribes to keyboard input notifications. 
                    This demonstrates the application's ability to respond to input events across thread boundaries.
                </p>
                <p>
                    The Thread Subscriber service creates a new thread that can receive and process messages from the notification 
                    center, showing how the application handles cross-thread communication.
                </p>
            </div>

            <div class="code-step">
                <h3>3. WebSocket Manager Initialization</h3>
                <p>
                    <code>U7WebSocketManager.test()</code> initializes the WebSocket server component that listens on port 9203. 
                    This service handles all incoming WebSocket connections and related communication.
                </p>
                <p>
                    The WebSocket Manager provides an asynchronous communication channel for external clients to interact with the 
                    application, demonstrating how the system can handle network I/O concurrently with other operations.
                </p>
            </div>

            <div class="code-step">
                <h3>4. Application Delegate Setup</h3>
                <p>
                    <code>AppDelegate *appDel = new AppDelegate();</code> creates an instance of the AppDelegate class which 
                    subscribes to specific notification channels. This demonstrates how easy it is to subscribe to messages 
                    supported by the pub/sub central notification service of the API.
                </p>
                <p>
                    The AppDelegate acts as a central coordination point for application-specific logic, showing how components 
                    can listen for and respond to specific events in a decoupled manner.
                </p>
            </div>

            <div class="code-step">
                <h3>5. Keyboard Input Monitor Initialization</h3>
                <p>
                    <code>var input_monitor = new U7KeyboardInputMonitor("U7KeyboardInputMonitor");</code> and 
                    <code>input_monitor.start();</code> create and start a thread dedicated to monitoring keyboard input 
                    from the command line interface.
                </p>
                <p>
                    This service provides a way for users to interact with the application through the command line, 
                    demonstrating real-time local input handling alongside network communications.
                </p>
            </div>

            <div class="code-step">
                <h3>6. Main Event Loop Startup</h3>
                <p>
                    <code>U7ThreadLoop.startMainEventLoop();</code> is a critical line that starts the application's main event processing loop.
                </p>
                <p>
                    The significance of this call being near the bottom of the main function is that it represents the point where 
                    initialization ends and the application begins its operational phase. This function call is blocking - it will 
                    not return until the application is shutting down.
                </p>
                <p class="highlight">
                    All code after this call will only execute during application termination, making this the proper location for 
                    cleanup operations, resource deallocation, and graceful shutdown procedures.
                </p>
            </div>
        </div>

        <h2>Application Architecture</h2>
        <p>
            The application follows a multi-threaded architecture with several key components:
        </p>
        <ul>
            <li><strong>Main Thread</strong>: Handles the main event loop and coordinates other threads</li>
            <li><strong>Thread Subscriber</strong>: Demonstrates cross-thread message passing</li>
            <li><strong>WebSocket Manager</strong>: Handles network communication via WebSockets</li>
            <li><strong>Keyboard Input Monitor</strong>: Monitors and processes CLI input</li>
            <li><strong>AppDelegate</strong>: Subscribes to notifications to demonstrate the pub/sub pattern</li>
        </ul>

        <h2>Communication Flow</h2>
        <p>
            The application uses a central notification system for inter-component communication. This pub/sub pattern allows:
        </p>
        <ul>
            <li>Decoupled components that can communicate without direct dependencies</li>
            <li>Cross-thread message passing with proper synchronization</li>
            <li>Event-driven architecture where components respond to notifications</li>
            <li>Support for both local input (keyboard) and remote input (WebSockets)</li>
        </ul>

        <div class="note">
            <strong>Design Philosophy:</strong> The architecture demonstrates fundamental concerns of a multithreaded application:
            <ul>
                <li>Thread safety through proper locking mechanisms</li>
                <li>Asynchronous I/O handling (both network and stdin)</li>
                <li>Event-driven programming with a central event loop</li>
                <li>Modular components with clear responsibilities</li>
                <li>Bridge pattern for interfacing with C libraries</li>
            </ul>
        </div>

        <h2>Conclusion</h2>
        <p>
            The <code>main()</code> function in <code>websocket_endpoint.vala</code> demonstrates a well-structured initialization sequence 
            for a multithreaded application that manages multiple asynchronous communication channels. The careful ordering of service 
            initialization followed by the start of the main event loop ensures all components are properly set up before the application 
            begins processing events.
        </p>
        <p>
            This architecture enables the application to handle both WebSocket connections and local CLI input concurrently, while 
            maintaining a clean separation of concerns between different components through the use of a central notification system.
        </p>
    </div>
</body>
</html>